require('dotenv').config();
const { Client, GatewayIntentBits, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const fs = require('fs');

const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù…Ù„Ù
let players = {};
try {
    players = JSON.parse(fs.readFileSync('./points.json', 'utf8'));
} catch (err) {
    console.log('Ù…Ù„Ù Ø§Ù„Ù†Ù‚Ø§Ø· ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
    players = {};
}

client.once('ready', () => {
    console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¨ÙˆØª ${client.user.tag}`);
});

client.on('messageCreate', async (message) => {
    if (message.content === '!Ø³Ø¤Ø§Ù„') {
        const question = "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙØ±Ù†Ø³Ø§ØŸ";
        const correctAnswer = "Ø¨Ø§Ø±ÙŠØ³";

        await message.channel.send(question);

        const filter = m => m.author.id && m.content;
        const collector = message.channel.createMessageCollector({ filter, time: 15000 });

        collector.on('collect', m => {
            if (m.content.toLowerCase() === correctAnswer.toLowerCase()) {
                if (!players[m.author.id]) players[m.author.id] = 0;
                players[m.author.id] += 10;

                // Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ù
                fs.writeFileSync('./points.json', JSON.stringify(players, null, 2));

                m.reply(`âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¢Ù† ${players[m.author.id]} Ù†Ù‚Ø§Ø·.`);
            }
        });

        collector.on('end', collected => {
            message.channel.send('â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!');
        });
    }

    if (message.content === '!Ø§Ù„ØªÙˆØ¨5') {
        const topPlayers = Object.entries(players)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        if (topPlayers.length === 0) return message.channel.send('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¹Ø¯.');

        const embed = new EmbedBuilder()
            .setTitle('ðŸ† Ø£Ø¹Ù„Ù‰ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ†')
            .setColor('Gold');

        topPlayers.forEach(([id, points], index) => {
            embed.addFields({ name: `#${index+1}`, value: `<@${id}> â€” ${points} Ù†Ù‚Ø§Ø·` });
        });

        message.channel.send({ embeds: [embed] });
    }
});

client.login(process.env.TOKEN);
