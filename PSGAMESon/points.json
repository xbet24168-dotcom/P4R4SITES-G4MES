require('dotenv').config();
const { Client, GatewayIntentBits, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const fs = require('fs');

const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });

// قراءة النقاط من الملف
let players = {};
try {
    players = JSON.parse(fs.readFileSync('./points.json', 'utf8'));
} catch (err) {
    console.log('ملف النقاط فارغ أو لا يوجد، سيتم إنشاؤه تلقائياً.');
    players = {};
}

client.once('ready', () => {
    console.log(`تم تسجيل الدخول كبوت ${client.user.tag}`);
});

client.on('messageCreate', async (message) => {
    if (message.content === '!سؤال') {
        const question = "ما هي عاصمة فرنسا؟";
        const correctAnswer = "باريس";

        await message.channel.send(question);

        const filter = m => m.author.id && m.content;
        const collector = message.channel.createMessageCollector({ filter, time: 15000 });

        collector.on('collect', m => {
            if (m.content.toLowerCase() === correctAnswer.toLowerCase()) {
                if (!players[m.author.id]) players[m.author.id] = 0;
                players[m.author.id] += 10;

                // حفظ النقاط في الملف
                fs.writeFileSync('./points.json', JSON.stringify(players, null, 2));

                m.reply(`✅ إجابة صحيحة! لديك الآن ${players[m.author.id]} نقاط.`);
            }
        });

        collector.on('end', collected => {
            message.channel.send('⏰ انتهى الوقت!');
        });
    }

    if (message.content === '!التوب5') {
        const topPlayers = Object.entries(players)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        if (topPlayers.length === 0) return message.channel.send('لا يوجد لاعبين بعد.');

        const embed = new EmbedBuilder()
            .setTitle('🏆 أعلى 5 لاعبين')
            .setColor('Gold');

        topPlayers.forEach(([id, points], index) => {
            embed.addFields({ name: `#${index+1}`, value: `<@${id}> — ${points} نقاط` });
        });

        message.channel.send({ embeds: [embed] });
    }
});

client.login(process.env.TOKEN);
